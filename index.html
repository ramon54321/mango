<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Mango</title>
		<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<style>
			body {
				background-color: #e0e0e0;
				font-family: 'Open Sans', sans-serif;
			}
			a {
				text-decoration: none;
				color: #2980b9;
				transition: 0.5s;
			}
			a:hover {
				color: #3498db;
			}
			.footer {
				height: 10px;
			}
			@media all and (max-width: 750px) {
				.menu, .newNote, .note {
					width: 100%;
				}
			}
			@media all and (min-width: 751px) {
				.menu, .newNote, .note {
					width: 700px;
					margin: 0 auto;
				}
			}
			#charNumberIndicator {
				float: right;
				font-size: 10pt;
			}
			.failure{
				color: #e74c3c;
			}
			.disabled{
				color: #95a5a6;
			}
			.menu, .menuSearchText, .newNote, .noteHeader, .noteBody {
				box-sizing: border-box;
			}
			.menu, .newNote {
				padding: 10px;
				border-radius: 10px;
				background-color: #e4f1fe;
			}
			.menu {
				display: table;
				padding-top: 5px;
				padding-bottom: 5px;
			}
			.menuRow {
				display: table-row;
			}
			.menuCellLeft {
				display: table-cell;
				vertical-align: middle;
				padding-right: 20px;
				white-space: nowrap;
			}
			.menuCellCenter {
				display: table-cell;
				width: 100%;
				position: relative;
			}
			.menuCellCenter2 {
				display: table-cell;
				vertical-align: middle;
				padding-left: 3px;
			}
			.menuCellRight {
				display: table-cell;
				vertical-align: middle;
				padding-left: 20px;
			}
			.menuSearchText {
				width: 100%;
				display: block;
				position: absolute;
				top: 50%;
				transform: translateY(-50%);
			}
			.menuNeedReload {
				color: #e74c3c;
				transition: 0.25s;
			}
			.newNoteText {
				width: 100%;
				box-sizing: border-box;
			}
			.note {
				display: table;
				position: relative;
			}
			.noteRow {
				display: table-row;
			}
			.noteStripe, .noteEmpty, .noteHeader, .noteBody {
				display: table-cell;
			}
			.noteStripe {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 25px;
				border-radius: 10px 0 0 10px;
			}
			.noteRed, .noteBlue, .noteGreen {
				cursor: pointer;
				transition: 0.5s;
			}
			.noteRed {
				background-color: #e74c3c;
			}
			.noteRed:hover {
				background-color: #c0392b;
			}
			.noteBlue {
				background-color: #3498db;
			}
			.noteBlue:hover {
				background-color: #2980b9;
			}
			.noteGreen {
				background-color: #00d070;
			}
			.noteGreen:hover {
				background-color: #27ae60;
			}
			.noteEmpty {
				width: 25px;
			}
			.noteHeader, .noteBody {
				padding: 8px 10px 8px 10px;
			}
			.noteHeader {
				border-radius: 0 10px 0 0;
				font-size: 80%;
				background-color: #e4f1fe;
			}
			.noteHeaderCompleted {
				float: right;
			}
			.noteHeaderRound {
				border-radius: 10px 10px 0 0;
			}
			.noteBody {
				white-space: pre-wrap;
				border-radius: 0 0 10px 0;
				background-color: #ffffff;
				font-size: 10pt;
			}
			.noteBodyRound {
				border-radius: 0px 0px 10px 10px;
			}
			.tag {
				color: #2980b9;
				font-style: italic;
				cursor: pointer;
			}
			.sign {
				width: 250px;
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				border-radius: 20px;
				background-color: #ffffff;
			}
			.signHeader, .signLeftTab, .signRightTab, .signBody, .signItem, .signInput, .signSubmit {
				box-sizing: border-box;
			}
			.signHeader, .signItem, .signInput, .signSubmit {
				width: 100%;
			}
			.signHeader, .signLeftTab, .signRightTab {
				border-radius: 20px 20px 0 0;
				background-color: #e4f1fe;
			}
			.signLeftTab, .signRightTab {
				display: inline-block;
				width: 50%;
				padding: 10px;
				text-align: center;
			}
			.signRightTab {
				float: right;
			}
			.signBody {
				padding: 15px;
			}
			.signItem, .signSuccess, .signFailure, .signLoading {
				padding: 10px;
			}
			.signFailure {
				color: #e74c3c;
			}
			.signLoading {
				color: #3498db;
			}
			.signSubmit {
				display: inline-block;
				padding: 6px;
				padding-left: 12px;
				padding-right: 12px;
				border-radius: 5px;
				background-color: #3498db;
				color: #ffffff;
				transition: 0.5s;
				text-align: center;
			}
			.signSubmit:hover {
				background-color: #2980b9;
			}
			textarea {
				resize: none;
			}
		</style>
		<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
		<script>
			var notifiSocket;
			var notifiSkipNext;
			function showMenu() {
				$('body').append(
					'<div class="menu">'
					+ '<div class="menuRow">'
					+ '<div class="menuCellLeft"><a id="commandNew" href="javascript:void(0)"><i class="fa fa-plus" style="font-size: 1.5em;"></i></a></div>'
					+ '<div class="menuCellLeft"><a id="commandReload" href="javascript:void(0)"><i class="fa fa-refresh" style="font-size: 1.3em;"></i></a></div>'
					+ '<div class="menuCellCenter"><input class="menuSearchText" type="text"></div>'
					+ '<div class="menuCellCenter2"><a id="commandSearch" href="javascript:void(0)"><i class="fa fa-search" style="font-size: 1.2em;"></i></a></div>'
					+ '<div class="menuCellRight"><a id="commandSignOut" href="javascript:void(0)"><i class="fa fa-sign-out" style="font-size: 1.6em;"></i></a></div>'
					+ '</div>'
					+ '</div>'
					+ '<div id="menuFooter" class="footer"></div>');
				$('#commandReload').click(onReload);
				$('#commandNew').click(onNew);
				$('#commandSignOut').click(onSignOut);
				$('.menuSearchText').keypress(function (event) {
					if (event.which == 13) {
						onSearch();
					}
				});
				$('#commandSearch').click(onSearch);
				notifiSkipNext = false;
				notifiSocket = new WebSocket('ws://localhost:8080/mango/websocket');
				notifiSocket.onmessage = function() {
					if (notifiSkipNext) {
						notifiSkipNext = false;
					} else {
						$('#commandReload').addClass('menuNeedReload');
					}
				}
			}
			function hideMenu() {
				$('.menu, #menuFooter').remove();
				notifiSocket.close();
			}
			function onReload() {
				$('#commandReload').removeClass('menuNeedReload');
				hideNewNote();
				hideNotes();
				showNotes();
			}
			function showNewNote() {
				$('#menuFooter').after(
					'<div class="newNote">'
					+ '<textarea class="newNoteText" rows="10"></textarea>'
					+ '<a id="commandPost" href="javascript:void(0)">Post</a>'
					+ '<div id="charNumberIndicator"></div>'
					+ '</div>'
					+ '<div id="newNoteFooter" class="footer"></div>');
				$('#commandPost').click(onPost);
				$('.newNoteText').focus();
				$('.newNoteText').bind('input propertychange', function() {
					$('#charNumberIndicator').html(
						' ' + this.value.length + ' / 255'
					);
					if(this.value.length > 255){
						if(!$('#commandPost').hasClass('disabled')){
							$('#commandPost').addClass('disabled');
						}

						if(!$('#charNumberIndicator').hasClass('failure')){
							$('#charNumberIndicator').addClass('failure');
						}
					} else {
						if($('#commandPost').hasClass('disabled')){
							$('#commandPost').removeClass('disabled');
						}

						if($('#charNumberIndicator').hasClass('failure')){
							$('#charNumberIndicator').removeClass('failure');
						}
					}
				});
			}
			function hideNewNote() {
				$('.newNote, #newNoteFooter').remove();
			}
			function onNew() {
				if ($('.newNote').length == 0) {
					showNewNote();
				} else {
					hideNewNote();
				}
			}
			function onPost() {
				if($('.newNoteText').val().length > 255)
					return;

				notifiSkipNext = true;
				$.post('rest/notes', JSON.stringify({ note: $('.newNoteText').val() }), function() {
					$('#commandReload').removeClass('menuNeedReload');
					hideNewNote();
					hideNotes();
					showNotes();
				});
			}
			function onSearch() {
				searchText = $('.menuSearchText').val().replace(/#/g, '').replace(/ /g, '+');
				if (searchText) {
					$.get('rest/searchnotes/' + searchText, function (response) {
						hideNotes();
						showNotesImpl(response);
					});
				} else {
					$.get('rest/notes/', function (response) {
						hideNotes();
						showNotesImpl(response);
					});
				}
			}
			function getLocalDate() {
				d = new Date();
				s = d.getFullYear();
				s += '-';
				if (d.getMonth() + 1 < 10) {
					s += '0';
				}
				s += d.getMonth() + 1;
				s += '-';
				if (d.getDate() < 10) {
					s += '0';
				}
				s += d.getDate();
				return s;
			}
			function getTimeOrDate(date, currentDate) {
				if (date.substring(0, 10) === currentDate) {
					date = date.substring(11, 16);
				} else {
					date = date.substring(11, 16)
						+ ' on '
						+ date.substring(0, 10);
				}
				return date;
			}
			function showNotesImpl(notes) {
				notes.sort(function(a, b) {
					return a.sortOrder - b.sortOrder;
				});
				currentDate = getLocalDate();
				for (var i = 0; i < notes.length; i++) {
					if (notes[i].completed) {
						stripeClass = '';
						headerClass = 'noteHeader noteHeaderRound';
						bodyClass = 'noteBody noteBodyRound';
					} else {
						if (notes[i].note.indexOf('#highpriority') != -1) {
							stripeClass = 'noteStripe noteRed';
						} else if (notes[i].note.indexOf('#lowpriority') != -1) {
							stripeClass = 'noteStripe noteGreen';
						} else {
							stripeClass = 'noteStripe noteBlue';
						}
						headerClass = 'noteHeader';
						bodyClass = 'noteBody';
					}
					if (notes[i].completed) {
						header =
							'Posted by '
							+ notes[i].user.username
							+ ' at '
							+ getTimeOrDate(notes[i].dateCreated, currentDate)
							+ '<span class="noteHeaderCompleted">Completed by '
							+ notes[i].userCompleted.username
							+ ' at '
							+ getTimeOrDate(notes[i].dateCompleted, currentDate)
							+ '</span>';
					} else {
						header =
							notes[i].user.username
							+ ' at '
							+ getTimeOrDate(notes[i].dateCreated, currentDate);
					}
					var text = notes[i].note;
					var text2 = '';
					var k = 0;
					var beg = -1;
					var end = 0;
					while (true) {
						if (k == text.length) {
							if (beg == -1) {
								text2 += text.substring(end);
							} else {
								text2 +=
									'<span class="tag">'
									+ text.substring(beg)
									+ '</span>';
							}
							break;
						}
						if (text[k] == '#') {
							text2 += text.substring(end, k);
							beg = k;
						}
						if (text[k] == ' ' && beg != -1) {
							text2 +=
								'<span class="tag">'
								+ text.substring(beg, k)
								+ '</span>';
								beg = -1;
								end = k;
						}
						k++;
					}
					var note =
						'<div class="note" data-noteId="'
						+ notes[i].noteId
						+ '">'
						+ '<div class="noteRow">';
					if (stripeClass) {
						note +=
						'<div class="'
						+ stripeClass
						+ '">'
						+ '</div>';
					}
					note +=
						'<div class="'
						+ headerClass
						+ '">'
						+ header
						+ '</div>'
						+ '</div>'
						+ '<div class="noteRow">';
					if (stripeClass) {
						note +=
						'<div class="noteEmpty">'
						+ '</div>';
					}
					note +=
						'<div class="'
						+ bodyClass
						+ '">'
						+ text2
						+ '</div>'
						+ '</div>'
						+ '</div>'
						+ '<div class="footer">'
						+ '</div>';
					$('body').append(note);
				}
				$('.noteRed, .noteBlue, .noteGreen').click(onComplete);
				$('.tag').click(onTag);
			}
			function showNotes() {
				$.get('rest/notes', function (response) {
					showNotesImpl(response);
				});
			}
			function hideNotes() {
				$('.note, .noteHeader, .noteBody').remove();
				$('.footer').not('#menuFooter, #newNoteFooter').remove();
			}
			function onComplete() {
				$.ajax({
					type: 'PUT',
					url: 'rest/notes/complete/' + $(this).parent().parent().attr('data-noteId'),
					success: function() {
						hideNotes();
						showNotes();
					}
				});
			}
			function onTag() {
				v = $('.menuSearchText').val();
				if (v) {
					v += ' ';
				}
				v += $(this).text();
				$('.menuSearchText').val(v);
			}
			function moveTabToFront(a, b) {
				a.css('background-color', '#ffffff');
				a.append('<span>' + a.children().remove().text() + '</span>');
				$('#username, #password').val('');
				$('#username').focus();
				$('#password').unbind('keypress').keypress(function (event) {
					if (event.which == 13) {
						b();
					}
				});
				$('.signSubmit').unbind('click').click(b);
				$('.signLoading, .signSuccess, .signFailure').remove();
			}
			function moveTabToBack(a, b) {
				a.css('background-color', '#e0f0ff');
				a.append('<a href="javascript:void(0)">' + a.children().remove().text() + '</a>');
				a.children().click(b);
			}
			function onSignLeftTab() {
				moveTabToFront($('.signLeftTab'), onSignIn);
				moveTabToBack($('.signRightTab'), onSignRightTab);
			}
			function onSignRightTab() {
				moveTabToFront($('.signRightTab'), onSignUp);
				moveTabToBack($('.signLeftTab'), onSignLeftTab);
			}
			function showSign() {
				$('body').append(
					'<div class="sign">'
					+ '<div class="signHeader">'
					+ '<span class="signLeftTab">'
					+ '<span>Sign in</span>'
					+ '</span>'
					+ '<span class="signRightTab">'
					+ '<span>Sign up</span>'
					+ '</span>'
					+ '</div>'
					+ '<div class="signBody">'
					+ '<div class="signItem">'
					+ '<input id="username" class="signInput" type="text" placeholder="Username">'
					+ '</div>'
					+ '<div class="signItem">'
					+ '<input id="password" class="signInput" type="password" placeholder="Password">'
					+ '</div>'
					+ '<div class="signItem">'
					+ '<a class="signSubmit" href="javascript:void(0)">Submit</a>'
					+ '</div>'
					+ '</div>'
					+ '</div>');
				moveTabToFront($('.signLeftTab'), onSignIn);
				moveTabToBack($('.signRightTab'), onSignRightTab);
			}
			function hideSign() {
				$('.sign').remove();
			}
			function onSignIn() {
				$('.signSubmit').unbind('click');
				$('.signLoading, signSuccess, .signFailure').remove();
				$('.signBody').append('<div class="signLoading">Signing in...</div>');
				$.ajax({
					type: 'PUT',
					url: 'rest/sessions',
					data: JSON.stringify({ username: $('#username').val(), password: $('#password').val() }),
					success: function(response) {
						if (response.status) {
							hideSign();
							showMenu();
							showNotes();
						} else {
							$('.signSubmit').click(onSignIn);
							$('.signLoading').remove();
							$('.signBody').append('<div class="signFailure">Incorrect username or password!</div>');
						}
					},
					error: function(xhr, textStatus, errorThrown) {
						$('.signSubmit').click(onSignIn);
						$('.signLoading').remove();
						$('.signBody').append('<div class="signFailure">' + errorThrown + '</div>');
					}
				});
			}
			function onSignOut() {
				$.ajax({
					type: 'DELETE',
					url: 'rest/sessions',
					async: false
				});
				hideMenu();
				hideNewNote();
				hideNotes();
				showSign();
			}
			function onSignUp() {
				$('.signSubmit').unbind('click');
				$('.signLoading, signSuccess, .signFailure').remove();
				$('.signBody').append('<div class="signLoading">Signing up...</div>');
				$.post('rest/users', JSON.stringify({ username: $('#username').val(), password: $('#password').val() }), function(response) {
					if (response.status) {
						$('.signLoading').remove();
						$('.signBody').append('<div class="signSuccess">You have been signed up!</div>');
					} else {
						$('.signSubmit').click(onSignUp);
						$('.signLoading').remove();
						$('.signBody').append('<div class="signFailure">' + response.message + '</div>');
					}
				});
			}
			function isSignedIn() {
				var a = false;
				$.ajax({
					type: 'GET',
					url: 'rest/sessions',
					async: false,
					success: function (response) {
						a = response.status;
					}
				});
				return a;
			}
			$(function () {
				$.ajaxSetup({ contentType: 'application/json' });
				if (isSignedIn()) {
					showMenu();
					showNotes();
				} else {
					showSign();
				}
			});
		</script>
	</head>
	<body>

	</body>
</html>
